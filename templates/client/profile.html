{% extends 'client/base.html' %}

{% block title %}User Profile{% endblock %}


{% block content %}
<section class="profile-section">
    <h2>Profile</h2>

    {% if profile.picture_status != 'approved' or profile.signature_status != 'approved' %}
    <div class="status-notification-section">
        <h3>Profile Status</h3>

        {% if profile.disapproval_reason %}
        <div class="disapproval-box">
            <p><strong>Disapproval Reason(s)</strong></p>
            <p>{{ profile.disapproval_reason }}</p>
            <p class="note">Please update your profile information and re-upload the required files below.
            </p>
        </div>
        {% endif %}

        <div class="status-badges">
            <div>
                <strong>1x1 Picture:</strong>
                <span class="status-badge 
                    {% if profile.picture_status == 'approved' %}status-approved
                    {% elif profile.picture_status == 'pending' %}status-pending
                    {% else %}status-disapproved{% endif %}">
                    {{ profile.picture_status | capitalize }}
                </span>
            </div>
            <div>
                <strong>Signature:</strong>
                <span class="status-badge
                    {% if profile.signature_status == 'approved' %}status-approved
                    {% elif profile.signature_status == 'pending' %}status-pending
                    {% else %}status-disapproved{% endif %}">
                    {{ profile.signature_status | capitalize }}
                </span>
            </div>
        </div>
        {% if profile.picture_status == 'pending' or profile.signature_status == 'pending' %}
        <p class="note">Your submissions are pending review by your class president.</p>
        {% endif %}
    </div>
    {% endif %}
    <div class="profile-container">
        <div class="photo-section">
            {% if profile.picture_url %}
            <div class="photo-box clickable-img">
                <img src="{{ profile.picture_url }}" alt="1x1 Picture">
            </div>
            {% else %}
            <div class="photo-box">No Picture Available</div>
            {% endif %}
        </div>

        <div class="info-section">
            <p><strong>Full Name:</strong> {{ profile.first_name }} {{ profile.middle_name }} {{
                profile.last_name }}</p>
            <p><strong>Program:</strong> {{ profile.program }}</p>
            <p><strong>Section:</strong> {{ profile.year_level }} {{ profile.section }} {% if profile.major
                %} {{ profile.major }} {% endif %}</p>
            <p><strong>Semester:</strong> {{ profile.semester }} Semester</p>
            <button class="edit-btn" id="editBtn">Edit</button>
        </div>

        <div class="signature-section">
            {% if profile.signature_url %}
            <div class="signature-box clickable-img">
                <img src="{{ profile.signature_url }}" alt="Signature">
            </div>
            {% else %}
            <div class="signature-box">No Signature Available</div>
            {% endif %}
        </div>
    </div>
</section>

<section class="edit-profile-section" id="editSection" style="display: none;">
    <form method="POST" action="{{ url_for('update_profile') }}" enctype="multipart/form-data">
        <h2>Edit Profile</h2>

        <div class="form-group-title">Personal Information</div>
        <div>
            <label>First Name</label>
            <input type="text" name="first_name" value="{{ profile.first_name }}" required>
        </div>
        <div>
            <label>Middle Name</label>
            <input type="text" name="middle_name" value="{{ profile.middle_name or '' }}">
        </div>
        <div>
            <label>Last Name</label>
            <input type="text" name="last_name" value="{{ profile.last_name }}" required>
        </div>

        <div class="form-group-title">Academic Information</div>
        <div>
            <label>Program</label>
            <select name="program" required>
                <option value="">Select Program</option>
                <option value="BSIT" {% if profile.program=='BSIT' %}selected{% endif %}>BSIT</option>
                <option value="BSIS" {% if profile.program=='BSIS' %}selected{% endif %}>BSIS</option>
                <option value="BSCS" {% if profile.program=='BSCS' %}selected{% endif %}>BSCS</option>
            </select>
        </div>
        <div>
            <label>Semester</label>
            <select name="semester" required>
                <option value="">Select Semester</option>
                <option value="1st" {% if profile.semester=='1st' %}selected{% endif %}>1st</option>
                <option value="2nd" {% if profile.semester=='2nd' %}selected{% endif %}>2nd</option>
            </select>
        </div>
        <div>
            <label>Year Level</label>
            <select name="year_level" id="edit_year_level" required onchange="toggleEditMajor()">
                <option value="">Select Year</option>
                <option value="1st Year" {% if profile.year_level=='1st Year' %}selected{% endif %}>1st Year
                </option>
                <option value="2nd Year" {% if profile.year_level=='2nd Year' %}selected{% endif %}>2nd Year
                </option>
                <option value="3rd Year" {% if profile.year_level=='3rd Year' %}selected{% endif %}>3rd Year
                </option>
                <option value="4th Year" {% if profile.year_level=='4th Year' %}selected{% endif %}>4th Year
                </option>
            </select>
        </div>
        <div>
            <label>Section</label>
            <select name="section" required>
                <option value="">Select Section</option>
                <option value="A" {% if profile.section=='A' %}selected{% endif %}>A</option>
                <option value="B" {% if profile.section=='B' %}selected{% endif %}>B</option>
                <option value="C" {% if profile.section=='C' %}selected{% endif %}>C</option>
                <option value="D" {% if profile.section=='D' %}selected{% endif %}>D</option>
            </select>
        </div>

        <div style="grid-column: 1 / -1;">
            <label>Major (for 3rd/4th Year)</label>
            <select name="major" id="edit_major"
                style="display: {% if profile.year_level in ['3rd Year','4th Year'] %}block{% else %}none{% endif %};">
                <option value="">Select Major</option>
                <option value="AMG" {% if profile.major=='AMG' %}selected{% endif %}>AMG</option>
                <option value="NETAD" {% if profile.major=='NETAD' %}selected{% endif %}>NETAD</option>
                <option value="WMAD" {% if profile.major=='WMAD' %}selected{% endif %}>WMAD</option>
                <option value="SMP" {% if profile.major=='SMP' %}selected{% endif %}>SMP</option>
            </select>
        </div>

        <div class="form-group-title">Upload Documents</div>
        <div class="upload-section">
            <label>1x1 Picture</label>
            <input type="file" name="picture" accept="image/*">
            <p class="note">Max 5MB. Resets approval to pending.</p>

            <label style="margin-top: 10px; display: block;">Signature (PNG with transparent background)</label>
            <input type="file" name="signature" accept=".png">
            <p class="note">Max 5MB. Transparent PNG only.</p>
        </div>

        <div class="form-actions">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
        </div>
    </form>
</section>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // --- Profile-Specific Variables ---
        const editBtn = document.getElementById('editBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const profileSection = document.querySelector('.profile-section');
        const editSection = document.getElementById('editSection');

        // Modal *opening* variables
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImageContent');
        const clickableImages = document.querySelectorAll('.clickable-img');

        // --- Profile Listeners ---
        if (editBtn) {
            editBtn.addEventListener('click', () => {
                if (profileSection) profileSection.style.display = 'none';
                if (editSection) editSection.style.display = 'block';
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                if (profileSection) profileSection.style.display = 'block';
                if (editSection) editSection.style.display = 'none';
            });
        }

        // --- Modal Opening Listeners ---
        clickableImages.forEach(el => {
            el.addEventListener('click', () => {
                if (modal && modalImg) {
                    const img = el.querySelector('img'); // Find the img tag inside the div
                    if (img) { // Check if we found an image
                        modal.style.display = 'flex';
                        modalImg.src = img.src; // Set the modal source
                    }
                }
            });
        });
        
        // Initialize major field visibility on load
        toggleEditMajor();
    });

    // --- Profile-Specific Functions ---
    function toggleEditMajor() {
        const major = document.getElementById('edit_major');
        const year = document.getElementById('edit_year_level');

        if (major && year) {
            if (year.value === '3rd Year' || year.value === '4th Year') {
                major.style.display = 'block';
            } else {
                major.style.display = 'none';
                major.value = '';
            }
        }
    }
</script>
{% endblock %}