{% extends "client/base.html" %}

{% block title %}My Profile{% endblock %}
{% block page_title %}My Profile{% endblock %}

{% block head %}
<style type="text/tailwindcss">
    input[type="file"]::file-selector-button {
        @apply px-4 py-2 bg-gray-600 text-gray-200 border-none rounded-md font-medium text-sm hover:bg-gray-700 cursor-pointer transition;
    }

    input[type="file"] {
         @apply text-gray-700 text-sm;
    }
</style>
{% endblock %}


{% block content %}

<div id="profile-view-section">

    {% if profile.picture_status != 'approved' or profile.signature_status != 'approved' %}
    <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Profile Status</h3>
        </div>
        <div class="p-6 space-y-4">

            {% if profile.disapproval_reason %}
            <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                <p class="font-bold mb-1">Disapproval Reason(s)</p>
                <p class="text-sm">{{ profile.disapproval_reason }}</p>
                <p class="text-sm mt-2 italic">Please update your profile information and re-upload the required files below.</p>
            </div>
            {% endif %}

            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                    <span class="font-medium text-gray-700">1x1 Picture:</span>
                    <span class="font-bold px-3 py-1 rounded-full text-sm
                        {% if profile.picture_status == 'approved' %} bg-green-100 text-green-800
                        {% elif profile.picture_status == 'pending' %} bg-yellow-100 text-yellow-800
                        {% else %} bg-red-100 text-red-800 {% endif %}">
                        {{ profile.picture_status | capitalize }}
                    </span>
                </div>
                <div class="flex-1 flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                    <span class="font-medium text-gray-700">Signature:</span>
                    <span class="font-bold px-3 py-1 rounded-full text-sm
                        {% if profile.signature_status == 'approved' %} bg-green-100 text-green-800
                        {% elif profile.signature_status == 'pending' %} bg-yellow-100 text-yellow-800
                        {% else %} bg-red-100 text-red-800 {% endif %}">
                        {{ profile.signature_status | capitalize }}
                    </span>
                </div>
            </div>

            {% if profile.picture_status == 'pending' or profile.signature_status == 'pending' %}
            <p class="text-sm text-gray-600 italic text-center">Your submissions are pending review by your class president.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="flex flex-col lg:flex-row gap-8">

        <div class="w-full lg:w-2/3">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Student Information</h3>
                        <p class="text-sm text-gray-500">Your personal and academic details.</p>
                    </div>
                    <button id="editBtn" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                        Edit
                    </button>
                </div>

                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">

                    {% macro profile_row(label, value) %}
                        <div class="py-2">
                            <span class="block text-sm font-medium text-gray-500">{{ label }}</span>
                            <span class="block text-lg font-medium text-gray-800">{{ value | default('N/A', true) }}</span>
                        </div>
                    {% endmacro %}

                    {# Updated to include suffix_name #}
                    {{ profile_row('Full Name', profile.first_name ~ ' ' ~ (profile.middle_name ~ ' ' if profile.middle_name else '') ~ profile.last_name ~ (' ' ~ profile.suffix_name if profile.suffix_name else '')) }}
                    
                    {{ profile_row('Student ID', profile.student_id) }}
                    {{ profile_row('Email', profile.email) }}
                    {{ profile_row('Program', profile.program) }}
                    {{ profile_row('Year & Section', profile.year_level ~ ' - ' ~ profile.section) }}

                    {% if profile.major %}
                        {{ profile_row('Major', profile.major) }}
                    {% endif %}

                     {{ profile_row('Semester', profile.semester ~ ' Semester') }}
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/3">
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Uploaded Images</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="block text-sm font-medium text-gray-500 mb-2">1x1 Picture</span>
                            <div class="aspect-square border border-gray-200 rounded-lg overflow-hidden">
                                {% if profile.picture_url %}
                                    <img src="{{ profile.picture_url }}" alt="1x1 Picture"
                                         class="w-full h-full object-cover cursor-pointer hover:opacity-80 transition"
                                         data-modal-trigger data-src="{{ profile.picture_url }}">
                                {% else %}
                                    <div class="w-full h-full bg-gray-100 flex items-center justify-center text-gray-400">
                                        <i class="fas fa-image fa-2x"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div>
                            <span class="block text-sm font-medium text-gray-500 mb-2">Signature</span>
                            <div class="aspect-square border border-gray-200 rounded-lg overflow-hidden p-2">
                                 {% if profile.signature_url %}
                                    <img src="{{ profile.signature_url }}" alt="Signature"
                                         class="w-full h-full object-contain cursor-pointer hover:opacity-80 transition"
                                         data-modal-trigger data-src="{{ profile.signature_url }}">
                                 {% else %}
                                     <div class="w-full h-full bg-gray-100 flex items-center justify-center text-gray-400">
                                        <i class="fas fa-signature fa-2x"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="editSection" style="display: none;">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <form method="POST" action="{{ url_for('core.update_profile') }}" enctype="multipart/form-data">

            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">Edit Profile</h3>
                <p class="text-sm text-gray-500">Update your information below.</p>
            </div>

            {% macro form_input(name, label, value, type='text', required=True) %}
            <div>
                <label for="{{ name }}" class="block text-sm font-medium text-gray-700 mb-1">{{ label }}</label>
                <input type="{{ type }}" name="{{ name }}" id="{{ name }}" value="{{ value | default('', true) }}"
                       {% if required %}required{% endif %}
                       class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
            </div>
            {% endmacro %}

            {% macro form_select(name, label, selected_val, options, id=None, onchange=None) %}
            <div>
                <label for="{{ id or name }}" class="block text-sm font-medium text-gray-700 mb-1">{{ label }}</label>
                <select name="{{ name }}" id="{{ id or name }}"
                        {% if onchange %}onchange="{{ onchange }}"{% endif %} required
                        class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <option value="">Select {{ label }}</option>
                    {% for option in options %}
                    <option value="{{ option.value }}" {% if option.value == selected_val %}selected{% endif %}>
                        {{ option.text }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endmacro %}

            <div class="p-6 space-y-4">
                <h4 class="text-lg font-semibold text-gray-700 border-b pb-2">Personal Information</h4>
                {# Changed grid to 4 columns to include Suffix #}
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {{ form_input('first_name', 'First Name', profile.first_name) }}
                    {{ form_input('middle_name', 'Middle Name', profile.middle_name, required=False) }}
                    {{ form_input('last_name', 'Last Name', profile.last_name) }}
                    {{ form_input('suffix_name', 'Suffix', profile.suffix_name, required=False) }}
                </div>
            </div>

            <div class="p-6 space-y-4 border-t border-gray-200">
                <h4 class="text-lg font-semibold text-gray-700 border-b pb-2">Academic Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    {{ form_select('program', 'Program', profile.program,
                                   options=[{'value': 'BSIT', 'text': 'BSIT'},
                                            {'value': 'BSIS', 'text': 'BSIS'},
                                            {'value': 'BSCS', 'text': 'BSCS'}],
                                   id='edit_program', onchange='toggleEditMajor()') }}

                    {{ form_select('semester', 'Semester', profile.semester,
                                   options=[{'value': '1st', 'text': '1st'},
                                            {'value': '2nd', 'text': '2nd'}]) }}

                    {{ form_select('year_level', 'Year Level', profile.year_level,
                                   options=[{'value': '1st Year', 'text': '1st Year'},
                                            {'value': '2nd Year', 'text': '2nd Year'},
                                            {'value': '3rd Year', 'text': '3rd Year'},
                                            {'value': '4th Year', 'text': '4th Year'}],
                                   id='edit_year_level', onchange='toggleEditMajor()') }}

                    {{ form_select('section', 'Section', profile.section,
                                   options=[{'value': 'A', 'text': 'A'},
                                            {'value': 'B', 'text': 'B'},
                                            {'value': 'C', 'text': 'C'},
                                            {'value': 'D', 'text': 'D'}]) }}
                </div>

                <div id="edit_major_wrapper" style="display: none;">
                    <label for="edit_major" class="block text-sm font-medium text-gray-700 mb-1">Major (for 3rd/4th Year)</label>
                    <select name="major" id="edit_major"
                            class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="">Select Major</option>
                        </select>
                </div>
            </div>

            <div class="p-6 space-y-4 border-t border-gray-200">
                <h4 class="text-lg font-semibold text-gray-700 border-b pb-2">Upload Documents</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="picture" class="block text-sm font-medium text-gray-700 mb-1">1x1 Picture</label>
                        <input type="file" name="picture" id="picture" accept="image/*"
                               class="w-full file:mr-4 file:border-0
                                      bg-white border border-gray-300 rounded-lg
                                      focus:outline-none focus:ring-2 focus:ring-blue-500 text-black">
                        <p class="text-xs text-gray-500 mt-1 italic">Max 5MB. Re-uploading will reset approval to pending.</p>
                    </div>
                    <div>
                        <label for="signature" class="block text-sm font-medium text-gray-700 mb-1">Signature (Transparent PNG)</label>
                        <input type="file" name="signature" id="signature" accept=".png"
                               class="w-full file:mr-4 file:border-0
                                      bg-white border border-gray-300 rounded-lg
                                      focus:outline-none focus:ring-2 focus:ring-blue-500 text-black">
                        <p class="text-xs text-gray-500 mt-1 italic">Max 5MB. Transparent PNG only.</p>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-end gap-4">
                <button type="button" id="cancelBtn" class="px-5 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // --- Get Elements ---
        const editBtn = document.getElementById('editBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const profileSection = document.getElementById('profile-view-section');
        const editSection = document.getElementById('editSection');

        // --- Toggle Listeners ---
        if (editBtn) {
            editBtn.addEventListener('click', () => {
                if (profileSection) profileSection.style.display = 'none';
                if (editSection) editSection.style.display = 'block';
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                // Reset form fields if needed (optional)
                // document.querySelector('#editSection form').reset();
                if (profileSection) profileSection.style.display = 'block';
                if (editSection) editSection.style.display = 'none';
            });
        }

        // --- Major Field Logic ---
        // Initialize major field visibility on page load
        toggleEditMajor();
    });

    // --- *** NEW: Dynamic Major Logic *** ---
    // 1. Define Major Options
    const majorOptions = {
        'BSIT': [
            { value: 'WMAD - A', text: 'WMAD - A' },
            { value: 'SMP - B', text: 'SMP - B' },
            { value: 'AMG - C', text: 'AMG - C' },
            { value: 'NETAD - D', text: 'NETAD - D' }
        ],
        'BSCS': [
            { value: 'GV', text: 'GV' },
            { value: 'IS', text: 'IS' }
        ],
        'BSIS': [] // No majors
    };

    // 2. Store the student's current major from Flask
    const currentMajor = "{{ profile.major or '' }}";

    // 3. Define the toggle function
    function toggleEditMajor() {
        const programEl = document.getElementById('edit_program');
        const yearEl = document.getElementById('edit_year_level');
        const majorWrapper = document.getElementById('edit_major_wrapper');
        const majorEl = document.getElementById('edit_major');

        // Check if elements exist before proceeding
        if (!programEl || !yearEl || !majorWrapper || !majorEl) {
            console.error("One or more elements for major toggle not found.");
            return; 
        }

        const programValue = programEl.value;
        const yearValue = yearEl.value;

        const majors = majorOptions[programValue] || [];
        const isMajorYear = yearValue === '3rd Year' || yearValue === '4th Year';
        const hasMajors = majors.length > 0;

        // Clear existing major options, keeping the placeholder
        majorEl.innerHTML = '<option value="">Select Major</option>'; 

        if (isMajorYear && hasMajors) {
            // Add new options
            majors.forEach(function(major) {
                const option = new Option(major.text, major.value);
                majorEl.add(option);
            });

            // Show and require
            majorWrapper.style.display = 'block';
            majorEl.required = true;

            // Re-select the student's current major if it's in the list
            // Check against the current value *before* trying to set it
            if (majors.some(m => m.value === currentMajor)) {
                 majorEl.value = currentMajor;
            } else {
                 majorEl.value = ""; // Default to placeholder if currentMajor isn't valid
            }


        } else {
            // Hide and unrequire
            majorWrapper.style.display = 'none';
            majorEl.value = ''; // Ensure value is empty when hidden
            majorEl.required = false;
        }
    }
    // --- *** END OF NEW LOGIC *** ---
</script>
{% endblock %}