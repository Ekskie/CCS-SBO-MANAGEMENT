<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Your Email | SOMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>

<body class="h-full font-sans" 
      style="background-image: url('/static/image/background.jpg'); background-repeat: no-repeat; background-size: cover; background-attachment: fixed;">

    <div class="flex flex-col items-center justify-center min-h-full w-full bg-black bg-opacity-60 p-6">

        <a href="{{ url_for('auth.home') }}">
            <img src="{{ url_for('static', filename='image/lspu.png') }}" alt="LSPU Logo" class="w-24 md:w-28 mb-4">
        </a>

        <div class="w-full max-w-md bg-white bg-opacity-10 backdrop-blur-lg rounded-xl shadow-2xl p-8 text-white text-center border border-white/20">
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="mb-6">
                        {% for message in messages %}
                            <div class="p-3 rounded-lg bg-green-500 bg-opacity-80 text-white text-sm font-medium shadow-md animate-fade-in-down">
                                <i class="fas fa-check-circle mr-2"></i> {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <i class="fas fa-envelope-open-text fa-3x text-blue-300 mb-6"></i>

            <h1 class="text-3xl font-bold mb-4">Check Your Email</h1>
            
            <p class="text-lg text-gray-200">
                We've sent a confirmation link to
                <br>
                <strong class="font-medium text-blue-300">{{ email }}</strong>
            </p>
            
            <p class="text-base text-gray-300 mt-4 mb-8">
                Please check your inbox (and spam folder) to complete your password reset.
            </p>

            <div class="border-t border-white/20 pt-6">
                <p class="text-sm text-gray-400 mb-3">Didn't receive the email?</p>
                
                <form action="{{ url_for('auth.check_email') }}" method="POST" id="resendForm">
                    <button type="submit" 
                            id="resendBtn"
                            class="group relative inline-flex items-center justify-center px-6 py-2 text-sm font-medium text-white transition-all duration-200 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btnText">Resend Email</span>
                        <span id="timer" class="hidden ml-1"></span>
                    </button>
                </form>
            </div>

            <div class="mt-8">
                <a href="{{ url_for('auth.login') }}" class="font-medium text-blue-400 hover:text-blue-300 hover:underline transition-colors">
                    &larr; Back to Login
                </a>
            </div>

        </div> 
        
        <footer class="absolute bottom-5 text-sm text-gray-400">
            © 2025 Laguna State Polytechnic University – BSIT 4C AMG B
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resendBtn = document.getElementById('resendBtn');
            const resendForm = document.getElementById('resendForm');
            const btnText = document.getElementById('btnText');
            const timerSpan = document.getElementById('timer');

            // 1. Check if backend requested an auto-start (from the first forgotten password email)
            // 'tojson' converts Python True/False to JS true/false
            const autoStart = {{ auto_start|tojson }};
            
            if (autoStart) {
                // Determine if we already have a RECENT timer running to avoid resetting it if the user refreshes quickly
                const existing = localStorage.getItem('lastResendTimestamp');
                const now = new Date().getTime();
                
                // Only set a new timestamp if one doesn't exist or if the existing one is old
                if (!existing || (Math.floor((now - parseInt(existing)) / 1000) > 60)) {
                    localStorage.setItem('lastResendTimestamp', now);
                }
            }

            // 2. Standard Timer Logic
            const lastResend = localStorage.getItem('lastResendTimestamp');
            
            if (lastResend) {
                const now = new Date().getTime();
                const diff = Math.floor((now - parseInt(lastResend)) / 1000);
                
                if (diff < 60) {
                    startCountdown(60 - diff);
                } else {
                    // Timer expired, clean up
                    localStorage.removeItem('lastResendTimestamp');
                }
            }

            resendForm.addEventListener('submit', function(e) {
                if (resendBtn.disabled) {
                    e.preventDefault();
                    return;
                }
                // Set timestamp immediately upon click
                localStorage.setItem('lastResendTimestamp', new Date().getTime());
            });

            function startCountdown(seconds) {
                resendBtn.disabled = true;
                timerSpan.classList.remove('hidden');
                
                let timeLeft = seconds;
                updateButtonText(timeLeft);

                const interval = setInterval(() => {
                    timeLeft--;
                    updateButtonText(timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        resendBtn.disabled = false;
                        btnText.textContent = "Resend Email";
                        timerSpan.classList.add('hidden');
                        localStorage.removeItem('lastResendTimestamp');
                    }
                }, 1000);
            }

            function updateButtonText(seconds) {
                btnText.textContent = "Resend available in";
                timerSpan.textContent = `${seconds}s`;
            }
        });
    </script>
</body>
</html>